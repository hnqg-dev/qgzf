<?php namespace app\index\controller;use app\BaseController;use app\index\Base;use think\facade\View;use think\facade\Session;use app\index\model\User;use app\index\model\Qgledger;use app\index\model\Qgaccount;class C0 extends BaseController{protected function f1(){(new Base())->verifyAppAccess();}public function f2(){if(!session('?user')){return redirect('/index/index/login');}$v5=session('uid');try{$v6=\think\facade\Db::name('qgledger')->where('uid',$v5)->count();}catch(\Exception $v7){\think\facade\Log::error('查询账本数量失败:' . $v7->getMessage());$v6=0;}try{$v8=\think\facade\Db::name('qgaccount')->where('uid',$v5)->count();}catch(\Exception $v7){\think\facade\Log::error('查询账户数量失败:' . $v7->getMessage());$v8=0;}View::assign(['ledgerCount'=>$v6,'accountCount'=>$v8]);return View::fetch('/index');}public function f3(){if($this->request->isPost()){if(!token()){return json(['status'=>0,'msg'=>'非法请求']);}$v9=htmlspecialchars(trim($this->request->post('username')));$v10=$this->request->post('password');$v11=(int)$this->request->post('remember',0);$v12=$this->request->ip();$v13='login_attempts_' . $v12;$v14=cache($v13)?:0;if($v14>=5){return json(['status'=>0,'msg'=>'尝试次数过多，请稍后再试']);}$v15=new User();$v16=$v15->login($v9,$v10);if($v16['status']===1){cache($v13,null);$v17=['uid'=>$v16['data']['uid'],'uname'=>$v16['data']['uname'],'uiphone'=>$v16['data']['uiphone'],'ifadm'=>$v16['data']['ifadm']?? 0,'nname'=>$v16['data']['nname']?? '','zname'=>$v16['data']['zname']?? ''];session('user',$v17);session('uid',$v17['uid']);if($v11){$v18=md5(uniqid());$v19=$v16['data'];Session::set('remember_token',$v18);$v15->where('uid',$v19['uid'])->update(['remember_token'=>$v18]);}return json(['status'=>1,'msg'=>'登录成功','url'=>'/']);}else{cache($v13,$v14+1,3600);return json(['status'=>0,'msg'=>$v16['msg']]);}}return View::fetch('/login');}public function f4(){if($this->request->isPost()){if(!token()){return json(['status'=>0,'msg'=>'非法请求']);}$v20=['uname'=>htmlspecialchars(trim($this->request->post('uname'))),'uiphone'=>htmlspecialchars(trim($this->request->post('uiphone'))),'upassword'=>$this->request->post('upassword')];$v12=$this->request->ip();$v13='register_attempts_' . $v12;$v14=cache($v13)?:0;if($v14>=3){return json(['status'=>0,'msg'=>'注册尝试次数过多，请稍后再试']);}$v15=new User();$v16=$v15->register($v20);if($v16['status']===1){cache($v13,null);try{$v21=public_path(). 'upload/face/' . $v20['uname'];$v22=public_path(). 'upload/pzimg/' . $v20['uname'];if(!is_dir($v21)){mkdir($v21,0777,true);}if(!is_dir($v22)){mkdir($v22,0777,true);}}catch(\Exception $v7){\think\facade\Log::error('创建用户文件夹失败:' . $v7->getMessage());}}else{cache($v13,$v14+1,3600);}return json($v16);}return View::fetch('/reg');}}