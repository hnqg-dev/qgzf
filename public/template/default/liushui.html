<!DOCTYPE html>
<html>
<head>
    <title>__WEBTIT__</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="__CSS__/bootstrap.min.css">
    <link rel="stylesheet" href="__CSS__/zbn.css">
    <link rel="stylesheet" href="__ICONF__/bootstrap-icons.min.css">
    <link rel="stylesheet" href="__ICONF__/qxqfont.css">
    <link rel="stylesheet" href="__ICONF__/flicon.css">
    <link rel="stylesheet" href="__ICONF__/qxqicon.css">
</head>
<body>

 {include file="common"}
 {include file="zbmenu"}
<div class="container py-2">
    <div class="ls-ledger-header">
        <div class="ls-title-container">
            <a href="{:url('index/zhangben/index')}" class="ls-back-button">
                <i class="bi bi-arrow-left-circle"></i> 
            </a>
            <h1 class="ls-ledger-title">
                流水 <span class="ls-ftitle"><?php echo $lname ?? ''; ?></span>
            </h1>
        </div>
        <div class="ls-summary-container">
            <div class="ls-summary-row">
                <div class="ls-summary-main">
                    <div class="ls-summary-label ls-text-huang">总结余 ¥: </div>
                    <div class="ls-summary-amount">{$totalBalance}</div>
                </div>
            </div>
            <div class="ls-income-expense-row">
                <div class="ls-income-group">
                    <div class="ls-summary-label">总收入 ¥: </div>
                    <div class="ls-summary-amount">{$totalIncome}</div>
                </div>
                
                <div class="ls-expense-group">
                    <div class="ls-summary-label">总支出 ¥: </div>
                    <div class="ls-summary-amount">{$totalExpense}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="ls-transactions-container">
        <div class="ls-transactions-content">
            <div class="ls-month-header">
                <div class="ls-month-info">
                    <i class="bi bi-calendar-month"></i>
                    <span id="dateDisplay" class="ls-date-display">{$currentYear}年{$currentMonth}月</span>
                    <button id="datePickerBtn" class="ls-date-picker-btn">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="ls-month-amounts">
                    <span class="ls-month-income">月收入 ¥{$currentMonthIncome}</span>
                    <span class="ls-month-expense">月支出 ¥{$currentMonthExpense}</span>
                </div>
            </div>
            {volist name="groupedRecords" id="dayRecords" key="date"}
            <div class="ls-day-header">
                <div class="ls-day-info">
                    <i class="qxqicon qxq-rili30"></i>
                    {$dayRecords[0]['day']}日 {$dayRecords[0]['weekday']}
                </div>
            </div>
            {volist name="dayRecords" id="record"}
            <div class="ls-transaction" data-bid="{$record.bid}">
                <div class="ls-transaction-description">
                    <span class="ls-transaction-icon {if $record.szid == 0}ls-shouru-bg{else}ls-zhichu-bg{/if}">
                        <i class="{$record.sicon}"></i>
                    </span>
                    {if $record.abstract == ''}{$record.sname}{else}{$record.abstract}{/if}
                </div>
                <div class="ls-transaction-amount {if $record.szid == 0}ls-income-amount{else}ls-expense-amount{/if}">
                    ¥ {if $record.szid == 1}-{/if}{$record.money}
                    <span class="ls-action-icon">
                        <i class="bi bi-three-dots-vertical"></i>
                    </span>
                </div>
            </div>
            {/volist}
            {/volist}
            <div class="zw-bottom"> </div>
        </div>
    </div> 
</div>
<div class="modal fade" id="billDetailModal" tabindex="-1" aria-labelledby="billDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="billDetailModalLabel">流水详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="bill-detail-container">
                    <div class="bill-detail-row text-center mb-3">
                        <div class="bill-icon-container" id="billIconContainer">
                            <i class="bill-icon" id="billIcon" style="font-size:2rem"></i>
                        </div>
                    </div>
                    <div class="bill-detail-row text-center mb-3">
                        <h4 id="billCategoryName" class="bill-category-name"></h4>
                    </div>
                    <div class="bill-detail-row text-center mb-3">
                        <h3 id="billAmount" class="bill-amount"></h3>
                    </div>
                    <div class="bill-detail-row mb-3">
                        <hr class="bill-divider">
                    </div>
                    <div class="bill-detail-row mb-2">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">流水日期</div>
                            <div class="bill-info-value" id="billDate" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                    <div class="bill-detail-row mb-2">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">创建时间</div>
                            <div class="bill-info-value" id="billCreateTime" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                    <div class="bill-detail-row mb-2">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">账本名称</div>
                            <div class="bill-info-value" id="billLedgerName" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                    <div class="bill-detail-row mb-2">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">资产账户</div>
                            <div class="bill-info-value" id="billAccountName" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                    <div class="bill-detail-row mb-2">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">账户账号</div>
                            <div class="bill-info-value" id="billAccountNumber" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                    <div class="bill-detail-row mb-3">
                        <div class="bill-info-row">
                            <div class="bill-info-label" style="color: #585858;">摘要</div>
                            <div class="bill-info-value" id="billAbstract" style="color: #333333; text-align: left;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteBill()">删除记录</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<div id="datePickerModal" class="ls-date-picker-modal">
    <div class="ls-date-picker-content">
        <div class="ls-date-picker-header">
            <h5>请选择年份</h5>
            <button type="button" class="ls-date-picker-close" id="datePickerClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="ls-date-picker-body">
            <div class="ls-year-section">
                <div class="ls-year-navigation">
                    <button type="button" class="ls-year-nav-btn" id="prevYear">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span class="ls-current-year" id="currentYearDisplay">{$currentYear}年</span>
                    <button type="button" class="ls-year-nav-btn" id="nextYear">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="ls-month-section">
                <div class="ls-month-grid" id="monthGrid">
                </div>
            </div>
        </div>
        <div class="ls-date-picker-footer">
            <button type="button" class="ls-date-picker-current-month" id="datePickerCurrentMonth">本月</button>
            <button type="button" class="ls-date-picker-confirm" id="datePickerConfirm">确定</button>
        </div>
    </div>
</div>
<script src="__JS__/jquery.min.js"></script>
<script src="__JS__/bootstrap.bundle.min.js"></script>
<script src="__JS__/bootstrap.min.js"></script>
<script>
    var currentBillId = null;
    $(document).ready(function() {
        var selectedYear = {$currentYear};
        var selectedMonth = '{$currentMonth}';
        var availableYears = {:json_encode($availableYears)};
        var availableMonths = {:json_encode($availableMonths)};
        var allYearMonths = {:json_encode($allYearMonths)};
        initDatePicker();
        $('#datePickerBtn').click(function() {
            showDatePicker();
        });
        $('#datePickerClose').click(function() {
            hideDatePicker();
        });
        $('#datePickerConfirm').click(function() {
            confirmDateSelection();
        });
        $('#datePickerModal').click(function(e) {
            if (e.target === this) {
                hideDatePicker();
            }
        });
        $('#prevYear').click(function() {
            selectedYear--;
            selectedMonth = '';
            updateYearDisplay();
            updateMonthOptions();
        });
        $('#nextYear').click(function() {
            selectedYear++;
            selectedMonth = ''; 
            updateYearDisplay();
            updateMonthOptions();
        });
        $('#datePickerCurrentMonth').click(function() {
            var currentDate = new Date();
            selectedYear = currentDate.getFullYear();
            selectedMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            
            updateYearDisplay();
            updateMonthOptions();
        });
        
        function initDatePicker() {
            generateMonthOptions();
            setDefaultSelection();
            updateYearDisplay();
        }
        function generateMonthOptions() {
            var monthGrid = $('#monthGrid');
            monthGrid.empty();
            var months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            var currentYearMonths = allYearMonths[selectedYear] || [];
            
            months.forEach(function(month) {
                var monthItem = $('<div class="ls-month-item">' + month + '月</div>');
                monthItem.data('month', month);
                monthItem.click(function() {
                    selectMonth(month);
                });
                if (currentYearMonths.includes(month)) {
                    monthItem.addClass('has-data');
                }
                if (month == selectedMonth) {
                    monthItem.addClass('active');
                }
                
                monthGrid.append(monthItem);
            });
        }
        function setDefaultSelection() {
            $('.ls-month-item').each(function() {
                if ($(this).data('month') == selectedMonth) {
                    $(this).addClass('active');
                }
            });
        }
        
        function selectMonth(month) {
            selectedMonth = month;
            $('.ls-month-item').removeClass('active');
            $('.ls-month-item').each(function() {
                if ($(this).data('month') == month) {
                    $(this).addClass('active');
                }
            });
        }
        function updateYearDisplay() {
            $('#currentYearDisplay').text(selectedYear + '年');
        }
        function updateMonthOptions() {
            generateMonthOptions();
            setDefaultSelection();
        }
        function showDatePicker() {
            updateYearDisplay();
            $('#datePickerModal').fadeIn(200);
        }
        function hideDatePicker() {
            $('#datePickerModal').fadeOut(200);
        }
        function confirmDateSelection() {
            $('#dateDisplay').text(selectedYear + '年' + selectedMonth + '月');
            reloadWithSelectedDate(selectedYear, selectedMonth);
        }
    function reloadWithSelectedDate(year, month) {
        var currentUrl = window.location.href;
        var url = new URL(currentUrl);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);
        window.location.href = url.toString();
    }
    $('.ls-transaction').click(function() {
        var record = $(this);
        var bid = record.data('bid');
        if (!bid) {
            alert('无法获取流水记录ID');
            return;
        }
        currentBillId = bid;
        showBillDetail(bid);
    });
    function showBillDetail(bid) {
        $.ajax({
            url: '{:url("index/liushui/getBillDetail")}',
            type: 'GET',
            data: { bid: bid },
            dataType: 'json',
            success: function(response) {
                if (response.code === 200) {
                    fillBillDetailModal(response.data);
                    $('#billDetailModal').modal('show');
                } else {
                    alert(response.msg || '获取流水详情失败');
                }
            },
            error: function() {
                alert('网络错误，请稍后重试');
            }
        });
    }
    function fillBillDetailModal(billData) {
        console.log('流水详情数据:', billData);
        var iconContainer = $('#billIconContainer');
        var billIcon = $('#billIcon');
        billIcon.attr('class', billData.sicon + ' bill-icon');
        if (billData.szid == 0) { 
            iconContainer.css('background-color', '#cc2222');
        } else { 
            iconContainer.css('background-color', '#1166bb');
        }
        $('#billCategoryName').text(billData.sname);
        var amountText = billData.szid == 1 ? '-¥' + billData.money : '¥' + billData.money;
        var amountColor = billData.szid == 0 ? '#cc2222' : '#1166bb';
        $('#billAmount').text(amountText).css('color', amountColor);
        $('#billDate').text(billData.btime_formatted);
        $('#billCreateTime').text(billData.ctime_formatted);
        $('#billLedgerName').text(billData.lname);
        $('#billAccountName').text(billData.aname);
        $('#billAccountNumber').text(billData.anumber);
        $('#billAbstract').text(billData.abstract || '无');
    }
    });
    function deleteBill() {
        console.log('删除按钮被点击，currentBillId:', currentBillId);
        if (!currentBillId) {
            alert('未选择要删除的记录');
            return;
        }
        if (confirm('删除此记录将会对关联资产账户的金额进行变更，是否继续删除操作？')) {
            $.ajax({
                url: '{:url("index/liushui/deleteBill")}',
                type: 'POST',
                data: { bid: currentBillId },
                dataType: 'json',
                success: function(response) {
                    if (response.code === 200) {
                        alert('流水记录删除成功！');
                        $('#billDetailModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.msg || '删除失败');
                    }
                },
                error: function() {
                    alert('网络错误，请稍后重试');
                }
            });
        }
    }
    </script>
</body>
</html>
